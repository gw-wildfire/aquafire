---
title: "Fire Count Stats"
author: "Jillian Allison"
date: "`r Sys.Date()`"
output: html_document
---

Run the Fire Count and GDE sections of the Objects.RMD file to get all spatial objects necessary to run this code. Download necessary files and put them in the raster_output folder before running. 

### Eco Region Key: 

   **code**                                           **region**
          1                                         Coast Range
         13                             Central Basin and Range
         14                              Mojave Basin and Range
          4                                            Cascades
          5                                       Sierra Nevada
          6  Central California Foothills and Coastal Mountains
          7                           Central California Valley
         78 Klamath Mountains/California High North Coast Range
          8                       Southern California Mountains
         80                            Northern Basin and Range
         81                             Sonoran Basin and Range
         85             Southern California/Northern Baja Coast
          9               Eastern Cascades Slopes and Foothills

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(sf)
library(here)
library(janitor)
library(raster)
library(rgdal)
library(fasterize)
library(exactextractr)
library(dplyr)
library(gridExtra)
library(kableExtra)
source("user/jillian/functions/remove_ag_urban.R")
source("user/jillian/functions/raster_to_ecoregions.R")
source("user/jillian/functions/stratified_sample.R")
source("user/jillian/functions/fire_count_violin_plot.R")
```

# Samples 
```{r}
set.seed(123) 
fire_count_1_sample <- stratified_sample(fire_count_1, gde_1, n = 1000)
fire_count_4_sample <- stratified_sample(fire_count_4, gde_4, n = 1000)
fire_count_5_sample <- stratified_sample(fire_count_5, gde_5, n = 1000)
fire_count_6_sample <- stratified_sample(fire_count_6, gde_6, n = 1000)
fire_count_7_sample <- stratified_sample(fire_count_7, gde_7, n = 1000)
fire_count_8_sample <- stratified_sample(fire_count_8, gde_8, n = 1000)
fire_count_9_sample <- stratified_sample(fire_count_9, gde_9, n = 1000)
fire_count_13_sample <- stratified_sample(fire_count_13, gde_13, n = 1000)
fire_count_14_sample <- stratified_sample(fire_count_14, gde_14, n = 1000)
fire_count_78_sample <- stratified_sample(fire_count_78, gde_78, n = 1000)
fire_count_80_sample <- stratified_sample(fire_count_80, gde_80, n = 1000)
fire_count_81_sample <- stratified_sample(fire_count_81, gde_81, n = 1000)
fire_count_85_sample <- stratified_sample(fire_count_85, gde_85, n = 1000)
```

# Summary Stats
```{r}
fire_count_1_stats <- fire_count_stats(fire_count_1_sample, eco_region_code = 1)
fire_count_4_stats <- fire_count_stats(fire_count_4_sample, eco_region_code = 4)
fire_count_5_stats <- fire_count_stats(fire_count_5_sample, eco_region_code = 5)
fire_count_6_stats <- fire_count_stats(fire_count_6_sample, eco_region_code = 6)
fire_count_7_stats <- fire_count_stats(fire_count_7_sample, eco_region_code = 7)
fire_count_8_stats <- fire_count_stats(fire_count_8_sample, eco_region_code = 8)
fire_count_9_stats <- fire_count_stats(fire_count_9_sample, eco_region_code = 9)
fire_count_13_stats <- fire_count_stats(fire_count_13_sample, eco_region_code = 13)
fire_count_14_stats <- fire_count_stats(fire_count_14_sample, eco_region_code = 14)
fire_count_78_stats <- fire_count_stats(fire_count_78_sample, eco_region_code = 78)
fire_count_80_stats <- fire_count_stats(fire_count_80_sample, eco_region_code = 80)
fire_count_81_stats <- fire_count_stats(fire_count_81_sample, eco_region_code = 81)
fire_count_85_stats <- fire_count_stats(fire_count_85_sample, eco_region_code = 85)

fire_count_stats_all <- rbind(fire_count_1_stats, fire_count_4_stats, 
                              fire_count_5_stats, fire_count_6_stats,
                              fire_count_7_stats, fire_count_8_stats,
                              fire_count_9_stats, fire_count_13_stats, 
                              fire_count_14_stats, fire_count_78_stats,
                              fire_count_80_stats, fire_count_81_stats,
                              fire_count_85_stats)
```

# Basic Visualizations 
```{r fig.align="center", echo = FALSE,fig.width = 14}
plot_fc_1 <- fire_count_violin_plot(fire_count_1_sample, eco_region_code = 1)
plot_fc_4 <- fire_count_violin_plot(fire_count_4_sample, eco_region_code = 4)
plot_fc_5 <- fire_count_violin_plot(fire_count_5_sample, eco_region_code = 5)
plot_fc_6 <- fire_count_violin_plot(fire_count_6_sample, eco_region_code = 6)
plot_fc_7 <- fire_count_violin_plot(fire_count_7_sample, eco_region_code = 7)
plot_fc_8 <- fire_count_violin_plot(fire_count_8_sample, eco_region_code = 8)
plot_fc_9 <- fire_count_violin_plot(fire_count_9_sample, eco_region_code = 9)
plot_fc_13 <- fire_count_violin_plot(fire_count_13_sample, eco_region_code = 13)
plot_fc_14 <- fire_count_violin_plot(fire_count_14_sample, eco_region_code = 14)
plot_fc_78 <- fire_count_violin_plot(fire_count_78_sample, eco_region_code = 78)
plot_fc_80 <- fire_count_violin_plot(fire_count_80_sample, eco_region_code = 80)
plot_fc_81 <- fire_count_violin_plot(fire_count_81_sample, eco_region_code = 81)
plot_fc_85 <- fire_count_violin_plot(fire_count_85_sample, eco_region_code = 85)

plot_fc_6
plot_fc_85
plot_fc_8 
```

# Logistic Regressions

```{r}
# Coast Range
fire_count_1_sample$gde <- factor(fire_count_1_sample$gde)
fire_count_1_glm <- glm(value ~ gde, data = fire_count_1_sample, family = "poisson")

# Cascades 
fire_count_4_sample$gde <- factor(fire_count_4_sample$gde)
fire_count_4_glm <- glm(value ~ gde, data = fire_count_4_sample, family = "poisson")

# Sierra Nevada - stat significant 
fire_count_5_sample$gde <- factor(fire_count_5_sample$gde)
fire_count_5_glm <- glm(value ~ gde, data = fire_count_5_sample, family = "poisson")

# Central CA Foothills and Coastal Mountains 
fire_count_6_sample$gde <- factor(fire_count_6_sample$gde)
fire_count_6_glm <- glm(value ~ gde, data = fire_count_6_sample, family = "poisson")

# Central California Valley
fire_count_7_sample$gde <- factor(fire_count_7_sample$gde)
fire_count_7_glm <- glm(value ~ gde, data = fire_count_7_sample, family = "poisson")

# Southern CA Mountains
fire_count_8_sample$gde <- factor(fire_count_8_sample$gde)
fire_count_8_glm <- glm(value ~ gde, data = fire_count_8_sample, family = "poisson")

# Eastern Cascades Slopes and Foothills - stat significant 
fire_count_9_sample$gde <- factor(fire_count_9_sample$gde)
fire_count_9_glm <- glm(value ~ gde, data = fire_count_9_sample, family = "poisson")

# Central Basin and Range - stat significant 
fire_count_13_sample$gde <- factor(fire_count_13_sample$gde)
fire_count_13_glm <- glm(value ~ gde, data = fire_count_13_sample, family = "poisson")

# Mojave Basin and Range - stat significant
fire_count_14_sample$gde <- factor(fire_count_14_sample$gde)
fire_count_14_glm <- glm(value ~ gde, data = fire_count_14_sample, family = "poisson")

# Klamath Mountains/California High North Coast Range - stat significant 
fire_count_78_sample$gde <- factor(fire_count_78_sample$gde)
fire_count_78_glm <- glm(value ~ gde, data = fire_count_78_sample, family = "poisson")

# Northern Basin and Range - stat significant 
fire_count_80_sample$gde <- factor(fire_count_80_sample$gde)
fire_count_80_glm <- glm(value ~ gde, data = fire_count_80_sample, family = "poisson")

# Sonoran Basin and Range 
fire_count_81_sample$gde <- factor(fire_count_81_sample$gde)
fire_count_81_glm <- glm(value ~ gde, data = fire_count_81_sample, family = "poisson")

# Southern CA and Northern Baja Coast
fire_count_85_sample$gde <- factor(fire_count_85_sample$gde)
fire_count_85_glm <- glm(value ~ gde, data = fire_count_85_sample, family = "poisson")
```



# Pretty summary tables 
```{r}
pretty_6 <- kable(fire_count_6_stats %>% select(-ecoregion_code), align = "c", col.names = c("Group", "Mean Fire Count", "Maximum Fire Count", "Mode (not including zeros)"), caption = "Central California Foothills and Coastal Mountains") %>%
  kable_styling(bootstrap_options = "striped")

pretty_85 <- kable(fire_count_85_stats %>% select(-ecoregion_code), align = "c", col.names = c("Group", "Mean Fire Count", "Maximum Fire Count", "Mode (not including zeros)"), caption = "Southern California/Northern Baja Coast") %>%
  kable_styling(bootstrap_options = "striped")

pretty_8 <- kable(fire_count_8_stats %>% select(-ecoregion_code), align = "c", col.names = c("Group", "Mean Fire Count", "Maximum Fire Count", "Mode (not including zeros)"), caption = "Southern California Mountains") %>%
  kable_styling(bootstrap_options = "striped")

pretty_6
pretty_8
pretty_85
```


## Actual Stats

```{r}
# Coast Range 
fire_count_1_sample <- stratified_sample(fire_count_1, gde_1, n = 1000)
fire_count_1_gdes <- fire_count_1_sample %>%
  filter(gde == 1)
fire_count_1_nongdes <- fire_count_1_sample %>%
  filter(gde == 0)

fire_count_1_stats <- fire_count_stats(fire_count_1_sample)


# Plot density curves for GDEs and non-GDEs
library(ggplot2)
# Create violin plot
ggplot(fire_count_1_sample, aes(x = gde, y = value, fill = gde)) +
  geom_violin(trim = FALSE) +
  scale_fill_manual(values = c("springgreen4", "dodgerblue"), name = "GDE Status") + 
  xlab("GDE Status") +
  ylab("Fire Count") +
  ggtitle("Distribution of Fire Counts in Non-GDEs vs GDEs") + 
  theme_minimal()


ggplot(fire_count_1_sample, aes(x = value, color = gde)) + 
  stat_ecdf() +
  scale_color_manual(values = c("springgreen4", "dodgerblue"), name = "GDE Status") +
  xlab("Fire Count") +
  ylab("Cumulative Proportion") +
  ggtitle("Cumulative Distribution of Fire Counts in GDEs vs Non-GDEs") + 
  theme_minimal()

```

```{r}
# Northern basin and range
fire_count_80_sample <- stratified_sample(fire_count_80, gde_80, n = 1000)

fire_count_80_stats <- fire_count_stats(fire_count_80_sample)

# Create violin plot
ggplot(fire_count_80_sample, aes(x = gde, y = value, fill = gde)) +
  geom_violin(trim = FALSE) +
  scale_fill_manual(values = c("#DDA15E", "#A3B18A")) +
  scale_x_discrete(labels = c('Non-GDE', 'GDE')) +
  xlab("") +
  ylab("Fire Count") +
  ggtitle("Distribution of Fire Counts in Non-GDEs vs GDEs") +
  theme_classic() +
  coord_flip() +
  theme(legend.position = 'none',
        plot.title = element_text(hjust = 0.5,
                                  size = 15),
        axis.text = element_text(size = 13,
                                 color = 'black'),
        axis.title = element_text(size = 15,
                                  color = 'black'),
        axis.title.x = element_text(vjust = -1.1),
        axis.text.x = element_text(vjust = -1.5))


  
```

```{r}
gde_6 <- raster("raster_output/gde_6.tif")
fire_count_6 <- raster("raster_output/fire_count_6.tif")
source("user/jillian/functions/stratified_sample.R")
source("user/jillian/functions/fire_count_stats.R")

set.seed(123)

# Central CA Foothills and Coastal Mountains
fire_count_6_sample <- stratified_sample(fire_count_6, gde_6, n = 1000)

fire_count_6_stats <- fire_count_stats(fire_count_6_sample)

# Create violin plot
ggplot(fire_count_6_sample, aes(x = gde, y = value, fill = gde)) +
  geom_violin(trim = FALSE) +
  scale_fill_manual(values = c("#DDA15E", "#A3B18A")) +
  scale_x_discrete(labels = c('Non-GDE', 'GDE')) +
  xlab("") +
  ylab("Fire Count") +
  ggtitle("Distribution of Fire Counts in Non-GDEs vs GDEs") +
  theme_classic() +
  coord_flip() +
  theme(legend.position = 'none',
        plot.title = element_text(hjust = 0.5,
                                  size = 15),
        axis.text = element_text(size = 13,
                                 color = 'black'),
        axis.title = element_text(size = 15,
                                  color = 'black'),
        axis.title.x = element_text(vjust = -1.1),
        axis.text.x = element_text(vjust = -1.5))

ggplot(fire_count_6_sample, aes(x = value, color = gde)) + 
  stat_ecdf() +
  scale_color_manual(values = c("springgreen4", "dodgerblue"), name = "GDE Status") +
  xlab("Fire Count") +
  ylab("Cumulative Proportion") +
  ggtitle("Cumulative Distribution of Fire Counts in GDEs vs Non-GDEs") + 
  theme_minimal()
  
```

```{r}
# fire_count_sample <- stratified_sample(fire_count_raster, gde_raster, n = 1000)

# write.csv(fire_count_sample, "user/jillian/csv213/fire_count_sample.csv", row.names=FALSE)
```
